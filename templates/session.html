<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>{{ name }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<!-- HEADER -->
<header class="top">
    <div class="header-left">
        {% if user.avatar %}
        <img
            src="https://cdn.discordapp.com/avatars/{{ user.id }}/{{ user.avatar }}.png"
            class="avatar"
        >
        {% endif %}

        <div>
            <h1>ğŸ“¦ {{ name }}</h1>
            <div class="muted">
                Logget ind som <strong>{{ user.name }}</strong>
                {% if admin %}<span class="badge admin">ADMIN</span>{% endif %}
            </div>

            <div class="actions">
                <a href="/" class="btn blue">â† Oversigt</a>
            </div>
        </div>
    </div>
</header>

<main class="container">

<!-- ğŸ§¾ ORDRER -->
<section class="card">
    <h2>ğŸ§¾ Ordrer</h2>

    {% if orders %}
    <table class="table">
        <thead>
            <tr>
                <th>Bruger</th>
                <th>Bestilling</th>
                <th>Total</th>
                {% if admin %}
                <th>Admin</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>

        {% for o in orders %}
            <tr>
                <td>{{ o.user }}</td>

                <td>
                    <ul class="item-list">
                    {% for item, amount in o.["items"].items() %}
                        {% if amount > 0 %}
                            <li>{{ item }} Ã— {{ amount }}</li>
                        {% endif %}
                    {% endfor %}
                    </ul>
                </td>

                <td>{{ "{:,}".format(o.total or 0) }} kr</td>

                {% if admin %}
                <td class="admin-actions">
                    <a class="icon-btn"
                       href="/edit_order/{{ name }}/{{ o.id }}"
                       title="Rediger ordre">âœï¸</a>

                    <a class="icon-btn danger"
                       href="/delete_order/{{ name }}/{{ o.id }}"
                       onclick="return confirm('Vil du slette denne ordre?')"
                       title="Slet ordre">âŒ</a>
                </td>
                {% endif %}
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="total-line">
        <strong>Samlet total:</strong>
        {{ "{:,}".format(total or 0) }} kr
    </div>

    {% else %}
        <p class="muted">Ingen ordrer endnu â€“ samlet total 0 kr</p>
    {% endif %}
</section>

<!-- ğŸ“¦ LAGERSTATUS -->
<section class="card">
    <h2>ğŸ“¦ Lagerstatus</h2>

    <div class="lager-grid">
        {% for item, s in lager_status.items() %}
        <div class="lager-item {{ s.level }}">
            <strong>{{ item }}</strong><br>
            {{ s.left }} / {{ s.max }}
        </div>
        {% endfor %}
    </div>
</section>

<!-- ğŸ›  ADMIN -->
{% if admin %}
<section class="card">
    <h2>ğŸ›  Admin</h2>
    <div class="admin-bar">
        <a href="/open_session" class="btn green">â• Ã…bn ny bestilling</a>
        <a href="/close_session" class="btn orange">ğŸ”’ Luk bestilling</a>
        <a href="/admin/audit" class="btn blue">ğŸ“œ Audit log</a>
    </div>
</section>
{% endif %}

</main>

<!-- ğŸ”„ REAL-TIME UPDATE -->
<script>
let lastHash = null;

async function pollSession() {
    try {
        const res = await fetch("/session_data/{{ name }}");
        const data = await res.json();

        if (lastHash && lastHash !== data.hash) {
            location.reload();
        }

        lastHash = data.hash;
    } catch (e) {
        console.error("Polling fejl", e);
    }
}

setInterval(pollSession, 2000);
</script>

</body>
</html>
