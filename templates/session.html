<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>{{ name }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<header class="top">
    <div>
        <h1>ğŸ“¦ {{ name }}</h1>
        <div class="muted">
            Logget ind som <strong>{{ user.name }}</strong>
            {% if admin %}<span class="badge admin">ADMIN</span>{% endif %}
        </div>
        <a href="/" class="btn blue">â† Oversigt</a>
    </div>
</header>

<main class="container">

<!-- ===================== -->
<!-- ğŸ§¾ ORDRER -->
<!-- ===================== -->
<section class="card">
    <h2>ğŸ§¾ Ordrer</h2>

    {% if orders %}

    <!-- ğŸ” FILTER -->
    <div style="margin-bottom:10px;">
        <label>
            <input type="checkbox" id="only-unpaid" onchange="toggleUnpaid()">
            Vis kun ikke-betalte ordrer
        </label>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>Bruger</th>
                <th>Bestilling</th>
                <th>Total</th>
                <th>Status</th>
                {% if admin %}<th>Admin</th>{% endif %}
            </tr>
        </thead>

        <tbody>
        {% for o in orders %}
        <tr data-paid="{{ 'true' if o.paid else 'false' }}">
            <td>{{ o.user }}</td>

            <td>
                <ul>
                {% for item, amount in o["items"].items() %}
                    {% if amount > 0 %}
                        <li>{{ item }} Ã— {{ amount }}</li>
                    {% endif %}
                {% endfor %}
                </ul>
            </td>

            <td>{{ "{:,}".format(o.total or 0) }} kr</td>

            <td>
                {% if o.paid %}ğŸŸ¢ Betalt{% endif %}
                {% if o.delivered %} ğŸ”µ Leveret{% endif %}
            </td>

            {% if admin %}
            <td class="admin-actions">

                <!-- ğŸŸ¢ BETALT / ğŸ”´ FORTRYD -->
                {% if not o.paid %}
                    <a class="icon-btn green"
                       href="/admin/order_paid/{{ name }}/{{ o.id }}"
                       title="Marker som betalt">ğŸ’°</a>
                {% else %}
                    <a class="icon-btn danger"
                       href="/admin/order_unpaid/{{ name }}/{{ o.id }}"
                       title="Fortryd betalt">â†©ï¸</a>
                {% endif %}

                <!-- ğŸ”µ LEVERET -->
                {% if o.paid and not o.delivered %}
                    <a class="icon-btn blue"
                       href="/admin/order_delivered/{{ name }}/{{ o.id }}"
                       title="Marker som leveret">ğŸ“¦</a>
                {% endif %}

                <!-- âœï¸ REDIGER (kun hvis ikke betalt) -->
                {% if not o.paid %}
                    <a class="icon-btn"
                       href="/edit_order/{{ name }}/{{ o.id }}"
                       title="Rediger ordre">âœï¸</a>
                {% else %}
                    <span class="icon-btn disabled" title="Ordre er betalt">ğŸ”’</span>
                {% endif %}

                <!-- âŒ SLET -->
                <a class="icon-btn danger"
                   href="/delete_order/{{ name }}/{{ o.id }}"
                   onclick="return confirm('Vil du slette denne ordre?')"
                   title="Slet ordre">âŒ</a>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
        </tbody>
    </table>

    <p class="total-line">
        <strong>Samlet total:</strong>
        {{ "{:,}".format(total or 0) }} kr
    </p>

    {% else %}
        <p class="muted">Ingen ordrer endnu.</p>
    {% endif %}
</section>

<!-- ===================== -->
<!-- ğŸ“¦ LAGERSTATUS -->
<!-- ===================== -->
<section class="card">
    <h2>ğŸ“¦ Lagerstatus</h2>
    <div class="lager-grid">
        {% for item, s in lager_status.items() %}
        <div class="lager-item {{ s.level }}">
            <strong>{{ item }}</strong><br>
            {{ s.left }} / {{ s.max }}
        </div>
        {% endfor %}
    </div>
</section>

<!-- ===================== -->
<!-- ğŸ›  ADMIN -->
<!-- ===================== -->
{% if admin %}
<section class="card">
    <h2>ğŸ›  Admin</h2>
    <div class="admin-bar">
        <a href="/open_session" class="btn green">â• Ã…bn ny bestilling</a>
        <a href="/close_session" class="btn orange">ğŸ”’ Luk bestilling</a>
        <a href="/admin/audit" class="btn blue">ğŸ“œ Audit</a>
    </div>
</section>
{% endif %}

</main>

<!-- ===================== -->
<!-- ğŸ” FILTER SCRIPT -->
<!-- ===================== -->
<script>
function toggleUnpaid() {
    const onlyUnpaid = document.getElementById("only-unpaid").checked;
    document.querySelectorAll("tbody tr").forEach(row => {
        const paid = row.dataset.paid === "true";
        row.style.display = (onlyUnpaid && paid) ? "none" : "";
    });
}
</script>

<!-- ===================== -->
<!-- ğŸ”„ REAL-TIME UPDATE -->
<!-- ===================== -->
<script>
let lastHash = null;

async function pollSession() {
    const res = await fetch("/session_data/{{ name }}");
    const data = await res.json();
    if (lastHash && lastHash !== data.hash) location.reload();
    lastHash = data.hash;
}

setInterval(pollSession, 2000);
</script>

</body>
</html>
