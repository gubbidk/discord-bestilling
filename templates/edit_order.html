<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Rediger ordre</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .edit-box {
            max-width: 650px;
            margin: auto;
        }

        .item-row {
            display: grid;
            grid-template-columns: 1fr 80px 120px 90px;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-row input {
            width: 70px;
            padding: 6px;
            text-align: center;
        }

        .price {
            opacity: 0.7;
            text-align: right;
        }

        .stock {
            font-size: 0.9em;
            text-align: right;
        }

        .stock.ok { color: #2ecc71; }
        .stock.warning { color: #f1c40f; }
        .stock.danger { color: #e74c3c; font-weight: bold; }

        .total {
            font-size: 1.4em;
            font-weight: bold;
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body>

<div class="card edit-box">
    <h2>‚úèÔ∏è Rediger ordre</h2>

    <form method="post" id="orderForm">
        {% for item, amount in order["items"].items() %}

        {% set max_amount = lager.get(item, 0) %}
        {% set level = "danger" if max_amount <= 0 else "warning" if max_amount < 5 else "ok" %}

        <div class="item-row">
            <span>{{ item }}</span>

            <input
                type="number"
                min="0"
                name="{{ item }}"
                value="{{ amount }}"
                data-price="{{ prices[item] }}"
                onchange="updateTotal()"
                onkeyup="updateTotal()"
            >

            <span class="price">{{ prices[item] }} kr</span>

            <span class="stock {{ level }}">
                üì¶ {{ max_amount }}
            </span>
        </div>
        {% endfor %}

        <div class="total">
            Total: <span id="totalPrice">{{ order.total }}</span> kr
        </div>

        <button class="btn primary" type="submit">
            üíæ Gem √¶ndringer
        </button>
    </form>
</div>

<script>
function updateTotal() {
    let total = 0;
    document.querySelectorAll("input[data-price]").forEach(input => {
        const amount = parseInt(input.value) || 0;
        const price = parseInt(input.dataset.price);
        total += amount * price;
    });
    document.getElementById("totalPrice").innerText = total;
}
</script>

<script>
let lastHash = null;

async function poll() {
    const res = await fetch("/session_data/{{ session_name }}");
    const data = await res.json();
    if (lastHash && lastHash !== data.hash) {
        location.reload();
    }
    lastHash = data.hash;
}
setInterval(poll, 5000);
</script>

</body>
</html>
