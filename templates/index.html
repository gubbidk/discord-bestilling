{% extends "base.html" %}
{% block content %}

{% if stats %}
<section class="card stats-dashboard">

    <div class="avatar-circle" style="
        position: relative;
        width: 96px;
        height: 96px;
        border-radius: 50%;
        overflow: hidden;
    ">
        <img
            src="https://cdn.discordapp.com/avatars/{{ user.id }}/{{ user.avatar }}.png"
            onerror="this.src='/static/default_avatar.png'"
            style="width:100%;height:100%;object-fit:cover;"
        >

        {% if stats.locked %}
        <div style="
            position:absolute;
            inset:0;
            background:rgba(0,0,0,0.7);
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:bold;
            color:#ff4d4d;
            pointer-events:none;
        ">
            ğŸ”’ LÃ…ST
        </div>
        {% endif %}
    </div>

    <h3>{{ user.name }}</h3>

    <div class="stats-grid">
        <div class="stat-box">
            <span>ğŸ’° Samlet brugt</span>
            <strong>{{ "{:,}".format(stats.total_spent) }} kr</strong>
        </div>
        <div class="stat-box">
            <span>ğŸ“¦ Varer kÃ¸bt</span>
            <strong>{{ stats.total_items }}</strong>
        </div>
        <div class="stat-box">
            <span>â­ Mest kÃ¸bt</span>
            <strong>{{ stats.most_bought or "â€”" }}</strong>
        </div>
    </div>

</section>
{% endif %}

<h2>ğŸ“‹ Bestillinger</h2>

<div class="grid">
{% for name, session in sessions.items() %}
    <div class="card">
        <h3>
            {{ name }}
            {% if not session.open %}ğŸ”’{% endif %}
        </h3>

        <p>ğŸ’° {{ totals.get(name, 0) }} kr</p>

        {% set ns = namespace(my_order=None) %}
        {% for o in session.orders %}
            {% if o.user_id == user.id %}
                {% set ns.my_order = o %}
            {% endif %}
        {% endfor %}

        <div class="actions">

            {% if ns.my_order %}
        <!-- ğŸŸ¢ Brugeren har allerede en ordre -->
                <a class="btn blue" href="/edit_own_order/{{ name }}/{{ ns.my_order.id }}">Ã…bn</a>

            {% elif session.open and not stats.locked %}
        <!-- â• Ingen ordre endnu -->
                <a class="btn green" href="/create_order/{{ name }}">â• Opret bestilling</a>

            {% elif not session.open %}
                <span class="badge closed">Lukket</span>
            {% endif %}

            {% if admin %}
                <a class="btn danger"
                    href="/delete_session/{{ name }}"
                    onclick="return confirm('Slet hele bestillingen?')">âŒ</a>
            {% endif %}

        </div>   
    </div>
{% endfor %}
</div>

{% if admin %}
<section class="card">
    <h2>ğŸ›  Admin</h2>
    <a class="btn blue" href="/admin">Admin panel</a>
</section>
{% endif %}

<script>
setInterval(() => location.reload(), 4000);
</script>

{% endblock %}
